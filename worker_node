#include "FS.h"
#include "SPIFFS.h"
#include "LoRaWan_APP.h"
#include "Arduino.h"

// ========== Sensor Definition ==========
enum SensorType {
  SENSOR_NONE,
  SENSOR_TEMPERATURE,
  SENSOR_ILLUMINANCE,
  SENSOR_HUMIDITY
};

SensorType currentSensor = SENSOR_NONE;

// ========== LoRa Config ==========
char txpacket[64];
bool lora_idle = true;
double txNumber = 0;

static RadioEvents_t RadioEvents;
void OnTxDone(void);
void OnTxTimeout(void);

// ========== Setup ==========
void setup() {
  Serial.begin(115200);
  delay(1000);
  Serial.println("ğŸ“¦ System initializing...");

  // SPIFFS init
  if (!SPIFFS.begin(true)) {
    Serial.println("âŒ Failed to initialize SPIFFS");
    while (1);
  }

  // LoRa init
  Mcu.begin(HELTEC_BOARD, SLOW_CLK_TPYE);
  RadioEvents.TxDone = OnTxDone;
  RadioEvents.TxTimeout = OnTxTimeout;
  Radio.Init(&RadioEvents);
  Radio.SetChannel(915000000); // 915 MHz
  Radio.SetTxConfig(MODEM_LORA, 5, 0, 0, 7, 1, 8,
                    false, true, 0, 0, false, 3000);

  Serial.println("âœ… System ready");

  updateDetectionTarget(SENSOR_TEMPERATURE); // Default sensor
}

// ========== Main Loop ==========
void loop() {
  // --- 1. ì‹œë¦¬ì–¼ë¡œ ì„¼ì„œ ì „í™˜ ---
  if (Serial.available()) {
    char cmd = Serial.read();
    if (cmd != '\n' && cmd != '\r') {
      switch (cmd) {
        case 't': updateDetectionTarget(SENSOR_TEMPERATURE); break;
        case 'l': updateDetectionTarget(SENSOR_ILLUMINANCE); break;
        case 'h': updateDetectionTarget(SENSOR_HUMIDITY); break;
        case 'n': updateDetectionTarget(SENSOR_NONE); break;
        default: Serial.println("â“ Unknown command"); break;
      }
    }
  }

  // --- 2. ì„¼ì„œ ë°ì´í„° ìˆ˜ì§‘ & ì €ì¥ ---
  String sensorData = readFromCurrentSensor();
  saveToStorage(sensorData);

   // --- 3. ìµœì‹  ì €ì¥ëœ ë°ì´í„°ë¥¼ LoRaë¡œ ì „ì†¡ ---
  if (lora_idle) {
    txNumber += 1;
    String latest = readLastLineFromStorage();  // ìƒˆë¡œ ì¶”ê°€ëœ í•¨ìˆ˜ ì‚¬ìš©
    snprintf(txpacket, sizeof(txpacket), "[%0.0f] %s", txNumber, latest.c_str());
    Serial.printf("ğŸ“¤ Sending from storage: %s\n", txpacket);
    Radio.Send((uint8_t*)txpacket, strlen(txpacket));
    lora_idle = false;
  }

  Radio.IrqProcess();
  delay(5000);
}

// ========== Sensor Logic ==========
void updateDetectionTarget(SensorType target) {
  deactivateAllSensors();
  currentSensor = target;

  switch (target) {
    case SENSOR_TEMPERATURE: Serial.println("ğŸŒ¡ï¸ Temp sensor activated"); break;
    case SENSOR_ILLUMINANCE: Serial.println("ğŸ’¡ Light sensor activated"); break;
    case SENSOR_HUMIDITY:    Serial.println("ğŸ’§ Humidity sensor activated"); break;
    default:                 Serial.println("âŒ No valid sensor selected"); break;
  }
}

void deactivateAllSensors() {
  Serial.println("ğŸ”Œ All sensors deactivated");
}

String readFromCurrentSensor() {
  int value = random(0, 100);

  switch (currentSensor) {
    case SENSOR_TEMPERATURE: return "Temp: " + String(value) + "C";
    case SENSOR_ILLUMINANCE: return "Light: " + String(value) + "lx";
    case SENSOR_HUMIDITY:    return "Humidity: " + String(value) + "%";
    default: return "No active sensor";
  }
}

// ========== SPIFFS ì €ì¥ ==========
void saveToStorage(String data) {
  File file = SPIFFS.open("/data.txt", FILE_APPEND);
  if (!file) {
    Serial.println("âŒ Failed to open file");
    return;
  }
  file.println(data);
  file.close();
  Serial.println("ğŸ’¾ Saved: " + data);
}

String readLastLineFromStorage() {
  File file = SPIFFS.open("/data.txt", FILE_READ);
  if (!file) {
    Serial.println("âŒ Failed to open file for reading");
    return "ERROR: No data";
  }

  String lastLine = "";
  while (file.available()) {
    lastLine = file.readStringUntil('\n');  // ê³„ì† ë®ì–´ì“°ê¸° â†’ ë§ˆì§€ë§‰ ì¤„ë§Œ ë‚¨ìŒ
  }

  file.close();
  return lastLine;
}


// ========== LoRa ì´ë²¤íŠ¸ ==========
void OnTxDone() {
  Serial.println("âœ… LoRa TX done");
  lora_idle = true;
}

void OnTxTimeout() {
  Serial.println("â±ï¸ LoRa TX timeout");
  lora_idle = true;
}
